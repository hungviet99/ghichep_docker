# Containerizing an app

## 1. Containerizing an app - The TLDR

Container nhằm làm cho các ứng dụng trở trên dễ dàng build, ship và run. 

Quá trình chứa 1 ứng dụng: 

1. Bắt đầu với code app và các phụ thuộc
2. Tạo `Dockerfile` mô tả ứng dụng, các phụ thuộc và cách chạy nó. 
3. Nạp `Dockerfile` vào lệnh `docker image build`
4. Push image mới vào registry(option)
5. Run container từ image

![](../images/docker9.png)

## 2. Containerizing an app - The deep dive

### 2.1. Containerize a single-container app

#### 2.1.1. Getting the application code

Down 1 ứng dụng web để thử nghiệm: 

```
git clone https://github.com/nigelpoulton/psweb.git
```

```
cd psweb
```

#### 2.1.2. Inspecting the Dockerfile

Dockerfile là điểm bắt đầu để tạo 1 image container, nó mô tả ứng dung và nói với docker cách để xây dưng nó thành 1 image. Thư mục chứa ứng dụng và các phụ thuộc được gọi là `build context`. Docker file bắt đầu bằng chữ `D` và được đặt tên như sau: `Dockerfile`. Ngoài nó ra các kiểu đặt tên khác không hợp lệ 

```
root@dockersrv:~/psweb# cat Dockerfile 

FROM alpine
LABEL maintainer="nigelpoulton@hotmail.com"
RUN apk add --update nodejs nodejs-npm
COPY . /src
WORKDIR /src
RUN  npm install
EXPOSE 8080
ENTRYPOINT ["node", "./app.js"]
```

Tất cả các tệp `Dockerfile` đều bắt đầu bằng lệnh `FROM`. Đây là lớp cơ sở của image và phần còn lại của ứng dụng sẽ được thêm lên đầu trang như các layer bổ sung. CỤ thể là 1 úng dụng linux, nên FROM đề cập đến 1 image trong linux. 

Tiếp theo, docker tạo ra `LABEL` là người duy trì image. lable là các cặp key-value đơn giản. 

`RUN apk add --update nodejs nodejs-npm` hướng dẫn Alpine apk sử dụng trình quản lý gói để cài đặt `nodejs` và `nodejs-npm` vào image.  Tại thời điểm này, nó tạo ra 1 layer mới ngay trên layer from và cài đặt các gói ở layer này. 

`COPY . /src` tạo 1 layer mới khác và copy file, thư mục từ host machine vào image. Có thể sử dụng url cho tập tin cần copy. 

Tiếp theo, `Dockerfile` sử dụng `WORKDIR` để đặt thư mục làm việc bên trong image file system

`VOLUME` mount hư mục từ máy host vào container

`RUN` để thực thi caai lệnh nào đó trong quá trinhg buil inmage

`EXPOSE` container sẽ lắng nghe trên các cổng mạng được chỉ định khi chạy. 

`ENTRYPOINT` để thực thi một số câu lệnh trong quá trình start container, những câu lệnh này sẽ dk viết trong file .sh

#### 2.1.3. Containerize the app/build the image

Sử dụng `docker image build` để build 1 image mới gọi là `web:latest`. Dấu `.` yêu cầu Docker sử dụng thư mục làm việc hiện tại của shell làm `build context`. 

```
docker image build -t web:latest .
```

Liệt kê các image để kiểm tra: 

```
root@dockersrv:~/psweb# docker image ls 

REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE
web                                  latest              b0e41055ddb3        10 minutes ago      93.5MB
```

#### 2.1.4. Pushing images

Để đẩy 1 image lên `Docker Hub`, bạn cần login với `Docker ID`. Bạn cũng cần gắn thẻ image thích hợp. 

Sử dụng lệnh `docker login` để đăng nhập vào docker. 

Trước khi đẩy 1 image, ta phải gắn thẻ nó theo 1 cách đặc biệt. Khi đẩy lên `Docker Hub`, ta phải thêm ID docker vào trước. 

```
docker image tag web:latest nigelpoulton/web:latest
```

Sau khi thay dổi tag, có thể push lên docker hub: 

```
docker image push nigelpoulton/web:latest
```

#### 2.1.5. Run the app

Chạy docker và trỏ port 80 từ Docker host đến port 8080 trong container. 
```
 docker container run -d --name c1 \
-p 80:8080 \
web:latest
```

Sau đó xác minh ánh xạ cổng: `

```
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS                          PORTS                    NAMES
40870fab83b5        web:latest            "node ./app.js"          19 seconds ago      Up 18 seconds                   0.0.0.0:80->8080/tcp     c1
```

#### 2.1.6. Looking a bit closer



